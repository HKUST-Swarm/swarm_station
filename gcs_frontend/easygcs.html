<html>

<head>
  <title>SWARM GCS</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous" />

  <script src="http://static.robotwebtools.org/threejs/current/three.min.js"></script>
  <script src="https://static.robotwebtools.org/threejs/r89/ColladaLoader.js"></script>
  <script src="http://static.robotwebtools.org/threejs/current/STLLoader.js"></script>
  <script src="http://static.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
  <script src="http://static.robotwebtools.org/roslibjs/current/roslib.min.js"></script>
  <script src="http://static.robotwebtools.org/ros3djs/current/ros3d.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
    integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
    integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
    crossorigin="anonymous"></script>
  <script src="./mavlink_bundle.js"></script>
</head>

<body>
  <div class="d-flex flex-column flex-md-row align-items-center p-3 px-md-4 mb-3 bg-white border-bottom shadow-sm">
    <h5 class="my-0 mr-md-auto font-weight-normal">Swarm EASY GCS</h5>
    <nav class="nav">
      <a class="p-2 text-dark" href="#">SELF ID: <span id="self_id">0</span>
      </a>
      <a class="p-2 text-dark" href="#">Total Remote Nodes: <span id="remote_nodes">0</span>
      </a>
      <a class="p-2 text-dark" href="#">Avail Remote Nodes: <span id="avail_remote_nodes">0</span>
      </a>
      <a class="p-2 text-dark" href="#">LastestLPSTIME: <span id="lps_time" style="color:green;">0</span>
      </a>
    </nav>
  </div>

  <script>
    var ros = new ROSLIB.Ros({
      url: "ws://localhost:9090"
    });
    ros.on("connection", function () {
      console.log("Connected to websocket server.");
    });

    var remote_nodes_listener = new ROSLIB.Topic({
      ros: ros,
      name: "/uwb_node/remote_nodes",
      messageType: "inf_uwb_ros/remote_uwb_info"
    });

    remote_nodes_listener.subscribe(function (msg) {
      // console.log("Received message on " + listener.name + ": ");
      // console.log(msg);
      $("#remote_nodes").html(msg.node_ids.length);
      $("#self_id").html(msg.self_id);
      $("#lps_time").html(msg.sys_time);
      var avail = 0;
      for (var i in msg.active) {
        // console.log(i);
        avail += msg.active[i];
      }
      $("#avail_remote_nodes").html(avail);
    });

    var incoming_data_listener = new ROSLIB.Topic({
      ros: ros,
      name: "/uwb_node/incoming_broadcast_data",
      messageType: "inf_uwb_ros/incoming_broadcast_data"
    });
    function _base64ToArrayBuffer(base64) {
      var binary_string = window.atob(base64);
      var len = binary_string.length;
      var bytes = new Uint8Array(len);
      for (var i = 0; i < len; i++) {
        bytes[i] = binary_string.charCodeAt(i);
      }
      return bytes;
    }
    var mav = new MAVLink(null, 0, 0);
    
    function on_drone_rt_info_recv(_id, lps_time, info) {
      // console.log(info);
    }
    
    function on_drone_status_recv(_id, lps_time, status) {
      console.log(status);
    }
    
    incoming_data_listener.subscribe(function (msg) {
      var buf = _base64ToArrayBuffer(msg.data);
      // console.log(buf);
      msgs = mav.parseBuffer(buf);
      // console.log(r);
      for (k in msgs) {
        msg = msgs[k];
        if (msg.name == "NODE_REALTIME_INFO") {
          on_drone_rt_info_recv(msg.remote_id, msg.lps_time, msg);
        } else if (msg.name == "DRONE_STATUS") {
          on_drone_status_recv(msg.remote_id, msg.lps_time, msg);
        }
      }
    });
    
  </script>
</body>

</html>